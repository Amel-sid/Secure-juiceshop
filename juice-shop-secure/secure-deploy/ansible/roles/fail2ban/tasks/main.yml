---
# ===================================================================
# FAIL2BAN - PROTECTION ANTI-INTRUSION CENTRALISÉE
# ===================================================================

# Supprimer anciennes configurations pour éviter conflits
- name: Nettoyer anciennes configurations Fail2ban
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/fail2ban/jail.d/sshd.conf
    - /etc/fail2ban/jail.d/nginx.conf
    - /etc/fail2ban/jail.d/ssh.local
    - /etc/fail2ban/jail.d/nginx.local
  tags: fail2ban

# Configuration centralisée et cohérente
- name: Configuration Fail2ban unifiée
  copy:
    dest: /etc/fail2ban/jail.d/devsecops-security.conf
    content: |
      # ===================================================================
      # CONFIGURATION FAIL2BAN 
      # ===================================================================
      
      [DEFAULT]
      # Paramètres globaux cohérents
      bantime = 3600        # 1 heure - équilibre sécurité/usabilité
      findtime = 600        # 10 minutes - fenêtre de détection
      maxretry = 3          # 3 tentatives standard
      ignoreip = 127.0.0.1/8 10.0.0.0/8 192.168.0.0/16
      
      # Protection SSH contre brute force
      [sshd]
      enabled = true
      port = ssh
      logpath = %(sshd_log)s
      filter = sshd
      # Utilise paramètres DEFAULT
      
      # Protection Nginx - Authentification échouée
      [nginx-http-auth]
      enabled = true
      port = http,https
      logpath = /var/log/nginx/juice-error.log
      filter = nginx-http-auth
      maxretry = 5          # Plus tolérant pour utilisateurs légitimes
      
      # Protection Nginx - Bots malveillants
      [nginx-badbots]
      enabled = true
      port = http,https
      logpath = /var/log/nginx/juice-access.log
      filter = nginx-badbots
      maxretry = 2          # Strict pour bots
      bantime = 86400       # 24h pour bots persistants
      
      # Protection Nginx - Scans de vulnérabilités
      [nginx-noscript]
      enabled = true
      port = http,https
      logpath = /var/log/nginx/juice-access.log
      filter = nginx-noscript
      maxretry = 2
      bantime = 86400
    mode: '0644'
  notify: restart fail2ban
  tags: fail2ban

# Activer et démarrer le service
- name: Activer Fail2ban
  systemd:
    name: fail2ban
    state: started
    enabled: true
  tags: fail2ban

# Vérification que la protection SSH fonctionne
- name: Vérifier jail SSH active
  command: fail2ban-client status sshd
  register: fail2ban_ssh_status
  failed_when: "'No jail' in fail2ban_ssh_status.stdout"
  changed_when: false
  tags: fail2ban

# Rapport de protection
- name: Rapport protection Fail2ban
  debug:
    msg: |
      ================================
      FAIL2BAN PROTECTION ACTIVE
      ================================
      SSH: {{ 'PROTÉGÉ' if 'Currently active' in fail2ban_ssh_status.stdout else 'INACTIF' }}
      Configuration: /etc/fail2ban/jail.d/devsecops-security.conf
      
      Paramètres de protection:
      - Bannissement: 1 heure (bots: 24h)
      - Fenêtre détection: 10 minutes
      - Tentatives max: 3 (web: 5, bots: 2)
      ================================
  tags: fail2ban