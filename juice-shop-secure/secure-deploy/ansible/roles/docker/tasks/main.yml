
- name: ğŸ›‘ CrÃ©er le groupe docker (A.9.2.3 - Moindre privilÃ¨ge)
  group:
    name: docker-admin
    state: present

# ğŸ“¦ Installer les paquets nÃ©cessaires pour gÃ©rer les dÃ©pÃ´ts HTTPS
# Ajoute la clÃ© GPG officielle pour que le systÃ¨me fasse confiance aux paquets Docker

# ConformitÃ© : A.12.6.1 (gestion des vulnÃ©rabilitÃ©s logicielles)
- name: ğŸ“¦ Installer dÃ©pendances Docker
  apt:
    name: 
      - apt-transport-https     # Pour que apt puisse tÃ©lÃ©charger depuis un dÃ©pÃ´t en HTTPS
      - ca-certificates         # VÃ©rifie que les certificats SSL des dÃ©pÃ´ts sont valides
      - curl                    # utilisÃ© pour rÃ©cupÃ©rer la clÃ© GPG
      - software-properties-common # gestion des dÃ©pÃ´ts
    state: present
    update_cache: yes
  tags: docker

# ğŸ” Ajout de la clÃ© GPG officielle de Docker
# Ajoute la clÃ© GPG officielle pour que le systÃ¨me fasse confiance aux paquets Docker
# ConformitÃ© : A.14.2.4 (intÃ©gritÃ© du code source)
- name: ğŸ” Ajouter clÃ© GPG Docker
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    state: present
  tags: docker


# â• Ajout du dÃ©pÃ´t Docker officiel
# Permet dâ€™installer les derniÃ¨res versions stables signÃ©es
- name: â• Ajouter dÃ©pÃ´t Docker stable
  apt_repository:
    repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
    state: present
    filename: docker
  tags: docker


# ğŸš€ Installation de Docker CE (Community Edition)
# ConformitÃ© : A.12.5.1 (installation contrÃ´lÃ©e de logiciels)
- name: ğŸš€ Installer Docker
  apt:
    name: 
      - docker-ce              # moteur Docker
      - docker-ce-cli          # CLI Docker
      - containerd.io          # runtime conteneurs
    state: latest
    update_cache: yes
  tags: docker


# ğŸ”„ Activer Docker au dÃ©marrage et le lancer
# ConformitÃ© : A.12.1.2 (configuration sÃ©curisÃ©e des systÃ¨mes)
- name: ğŸ”„ Activer et dÃ©marrer Docker
  service:
    name: docker
    state: started
    enabled: true
  tags: docker


# ğŸ” Restreindre les droits sur le socket Docker a root et docker-admin (A.9.2.3 â€“ Moindre privilÃ¨ge)
- name: ğŸ” Restreindre permissions du socket Docker
  file:
    path: /var/run/docker.sock
    mode: '0660'
    owner: root
    group: docker-admin
  when: ansible_facts.services['docker'].status == "running" # ExÃ©cute cette tÃ¢che seulement si Docker est dÃ©jÃ  en train de tourner.


#Isoler les utilisateurs Ã  lâ€™intÃ©rieur des conteneurs des utilisateurs sur lâ€™hÃ´te.
- name: ğŸ’¡ Activer userns-remap dans Docker
  copy:
    dest: /etc/docker/daemon.json
    content: |
      {
        "userns-remap": "default"
      }
  notify: restart docker

  tags: docker

- name: ğŸš« DÃ©sactiver IP forwarding (A.13.1.1 - ContrÃ´les rÃ©seau)
  sysctl:
    name: net.ipv4.ip_forward
    value: 0
    state: present
    reload: yes