# ğŸ”’ VÃ©rifier et rÃ©soudre les verrous APT
- name: ğŸ” VÃ©rifier les processus APT en cours
  shell: ps aux | grep -E "(apt|dpkg)" | grep -v grep
  register: apt_processes
  failed_when: false
  changed_when: false
  tags: docker

- name: ğŸ“‹ Afficher processus APT dÃ©tectÃ©s
  debug:
    msg: "Processus APT en cours : {{ apt_processes.stdout_lines }}"
  when: apt_processes.stdout_lines | length > 0
  tags: docker

# ğŸ›‘ Attendre que les processus APT se terminent
- name: â³ Attendre fin des processus APT/DPKG
  shell: |
    while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || \
          fuser /var/lib/apt/lists/lock >/dev/null 2>&1 || \
          fuser /var/cache/apt/archives/lock >/dev/null 2>&1; do
      echo "En attente de la libÃ©ration des verrous APT..."
      sleep 5
    done
  register: wait_result
  changed_when: false
  tags: docker

# ğŸ§¹ Nettoyer les verrous orphelins si nÃ©cessaire (en dernier recours)
- name: ğŸ§¹ Supprimer verrous orphelins si nÃ©cessaire
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /var/lib/apt/lists/lock
    - /var/lib/dpkg/lock-frontend
    - /var/cache/apt/archives/lock
  when: ansible_check_mode == false
  ignore_errors: true
  tags: docker

# ğŸ”„ Configurer APT pour Ã©viter les conflits
- name: ğŸ”„ Configurer APT
  shell: dpkg --configure -a
  ignore_errors: true
  tags: docker

# ğŸ“¦ Installer les paquets nÃ©cessaires pour gÃ©rer les dÃ©pÃ´ts HTTPS
# ConformitÃ© : A.12.6.1 (gestion des vulnÃ©rabilitÃ©s logicielles)
- name: ğŸ“¦ Installer dÃ©pendances Docker
  apt:
    name: 
      - apt-transport-https     # pour gÃ©rer les dÃ©pÃ´ts HTTPS
      - ca-certificates         # certificats SSL pour vÃ©rification des dÃ©pÃ´ts
      - curl                    # utilisÃ© pour rÃ©cupÃ©rer la clÃ© GPG
      - software-properties-common # gestion des dÃ©pÃ´ts
      - gnupg                   # pour la gestion des clÃ©s GPG
      - lsb-release            # pour dÃ©tecter la distribution
    state: present
    update_cache: yes
    lock_timeout: 300          # Attendre jusqu'Ã  5 minutes pour le verrou
  retries: 3
  delay: 10
  register: apt_result
  until: apt_result is succeeded
  tags: docker

# ğŸ§¹ Supprimer les anciennes versions de Docker (si prÃ©sentes)
- name: ğŸ§¹ Supprimer anciennes versions Docker
  apt:
    name:
      - docker
      - docker-engine
      - docker.io
      - containerd
      - runc
    state: absent
    lock_timeout: 300
  retries: 3
  delay: 10
  register: remove_result
  until: remove_result is succeeded
  tags: docker

# ğŸ” CrÃ©er le rÃ©pertoire pour les clÃ©s GPG
- name: ğŸ” CrÃ©er rÃ©pertoire keyrings
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  tags: docker

# ğŸ” TÃ©lÃ©charger et ajouter la clÃ© GPG officielle de Docker
# ConformitÃ© : A.14.2.4 (intÃ©gritÃ© du code source)
- name: ğŸ” TÃ©lÃ©charger clÃ© GPG Docker
  shell: |
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    chmod a+r /etc/apt/keyrings/docker.gpg
  args:
    creates: /etc/apt/keyrings/docker.gpg
  tags: docker

# â• Ajout du dÃ©pÃ´t Docker officiel avec la nouvelle mÃ©thode
# Permet d'installer les derniÃ¨res versions stables signÃ©es
- name: â• Ajouter dÃ©pÃ´t Docker stable
  shell: |
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  args:
    creates: /etc/apt/sources.list.d/docker.list
  tags: docker

# ğŸ”„ Mettre Ã  jour le cache des paquets aprÃ¨s ajout du dÃ©pÃ´t
- name: ğŸ”„ Mettre Ã  jour cache APT
  apt:
    update_cache: yes
    lock_timeout: 300
  retries: 3
  delay: 10
  register: update_result
  until: update_result is succeeded
  tags: docker

# ğŸš€ Installation de Docker CE (Community Edition)
# ConformitÃ© : A.12.5.1 (installation contrÃ´lÃ©e de logiciels)
- name: ğŸš€ Installer Docker CE
  apt:
    name: 
      - docker-ce              # moteur Docker
      - docker-ce-cli          # CLI Docker
      - containerd.io          # runtime conteneurs
      - docker-buildx-plugin   # plugin buildx pour constructions avancÃ©es
      - docker-compose-plugin  # plugin compose v2
    state: present
    update_cache: yes
    lock_timeout: 300
  retries: 3
  delay: 10
  register: install_result
  until: install_result is succeeded
  tags: docker

# ğŸ”„ Activer Docker au dÃ©marrage et le lancer
# ConformitÃ© : A.12.1.2 (configuration sÃ©curisÃ©e des systÃ¨mes)
- name: ğŸ”„ Activer et dÃ©marrer Docker
  systemd:
    name: docker
    state: started
    enabled: true
    daemon_reload: yes
  tags: docker

# âœ… VÃ©rifier que Docker fonctionne
- name: âœ… VÃ©rifier installation Docker
  command: docker --version
  register: docker_version
  changed_when: false
  tags: docker

- name: ğŸ“‹ Afficher version Docker
  debug:
    msg: "Docker installÃ© : {{ docker_version.stdout }}"
  tags: docker

# ğŸ” Configuration sÃ©curisÃ©e du daemon Docker
- name: ğŸ” CrÃ©er rÃ©pertoire configuration Docker
  file:
    path: /etc/docker
    state: directory
    mode: '0755'
  tags: docker

- name: ğŸ” Configuration sÃ©curisÃ©e daemon Docker
  copy:
    content: |
      {
        "log-driver": "json-file",
        "log-opts": {
          "max-size": "10m",
          "max-file": "3"
        },
        "live-restore": true,
        "userland-proxy": false,
        "no-new-privileges": true
      }
    dest: /etc/docker/daemon.json
    mode: '0644'
  notify: restart docker
  tags: docker

# ğŸ” Restreindre les droits sur le socket Docker (A.9.2.3 â€“ Moindre privilÃ¨ge)
- name: ğŸ” Restreindre permissions du socket Docker
  file:
    path: /var/run/docker.sock
    mode: '0660'
    owner: root
    group: docker
  tags: docker

# ğŸ”’ CrÃ©er groupe docker pour les utilisateurs autorisÃ©s
- name: ğŸ”’ CrÃ©er groupe docker
  group:
    name: docker
    state: present
  tags: docker