---
# ansible/roles/juice/tasks/main.yml

- name: üí• Supprimer ancienne installation (si elle existe)
  file:
    path: /opt/juice-shop
    state: absent
  become: yes

- name: üèóÔ∏è Cr√©er structure r√©pertoires Juice Shop
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: 1001
    group: 1001
  loop:
    - /opt/juice-shop
    - /opt/juice-shop/csaf
  become: yes

# Pr√©pare les dossiers  pour exposer les bulletins de s√©curit√© CSAF (.well-known/csaf)
# Simule un √©diteur logiciel conforme (divulgation responsable de vuln√©rabilit√©s)
- name: üìÑ Cr√©er provider-metadata.json (A.16.1.1	-Responsabilit√©s en mati√®re de gestion des incidents de s√©curit√©)
  copy:
    content: '{
      "metadata": {
        "publisher": "Juice Shop Security",
        "namespace": "https://juice-sh.op"
      }
    }'
    dest: /opt/juice-shop/csaf/provider-metadata.json
    owner: 1001
    group: 1001
    mode: '0644'
  become: yes


- name: ‚õì T√©l√©charger image Juice Shop (version stable)
  docker_image:
    name: bkimminich/juice-shop
    tag: v15.1.0
    source: pull
  become: yes

- name: üåê Cr√©er r√©seau Docker priv√©
  docker_network:
    name: juice_net
    driver: bridge
    state: present
  become: yes

- name: üöÄ Lancer conteneur Juice Shop (durci)
  docker_container:
    name: juice-shop
    image: bkimminich/juice-shop:v15.1.0
    security_opts:
      - no-new-privileges
      - seccomp=default
      - apparmor=docker-default
    state: started
    restart_policy: always
    published_ports:
      - "3000:3000"
    user: "1001"
    networks:
      - name: juice_net
    volumes:
      - "/opt/juice-shop/csaf:/juice-shop/.well-known/csaf:ro"
    read_only: true
    env:
      NODE_ENV: production
      CSAF_PUBLISHER_NAME: "Juice Shop"
    capabilities:
      drop:
        - ALL
    security_opts:
      - no-new-privileges
      - seccomp=default
      - apparmor=docker-default
  become: yes
  tags: juice

