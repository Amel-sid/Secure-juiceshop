---
# ğŸ›‘ Nettoyer les installations prÃ©cÃ©dentes
- name: ğŸ›‘ ArrÃªter conteneur Juice Shop existant
  docker_container:
    name: juice-shop
    state: absent
    force_kill: yes
  become: yes
  ignore_errors: yes

# ğŸŒ CrÃ©er rÃ©seau Docker pour Juice Shop
- name: ğŸŒ CrÃ©er rÃ©seau Docker
  docker_network:
    name: "{{ juice_shop_network }}"
    driver: bridge
    state: present
  become: yes

# â›“ TÃ©lÃ©charger image Juice Shop avec retry
- name: â›“ TÃ©lÃ©charger image Juice Shop
  docker_image:
    name: "{{ juice_shop_image }}"
    tag: "{{ juice_shop_version }}"
    source: pull
    timeout: 300  # 5 minutes
  become: yes
  retries: 3
  delay: 30
  register: pull_result
  until: pull_result is succeeded

# ğŸš€ Lancer conteneur Juice Shop
- name: ğŸš€ Lancer conteneur Juice Shop
  docker_container:
    name: juice-shop
    image: "{{ juice_shop_image }}:{{ juice_shop_version }}"
    state: started
    restart_policy: unless-stopped
    published_ports:
      - "{{ juice_shop_external_port }}:{{ juice_shop_internal_port }}"
    networks:
      - name: "{{ juice_shop_network }}"
    env:
      NODE_ENV: production
      PORT: "{{ juice_shop_internal_port | string }}"
      # DÃ©sactiver le chatbot problÃ©matique
      APPLICATION_CHATBOT: "false"
      CHATBOT_TRAINING_DATA: ""
      SOLUTIONS_WEBHOOK: ""
    # Limitations de ressources
    memory: 512m
    memory_swap: 512m
    cpu_quota: 50000  # 50% d'un CPU
    # SÃ©curitÃ©
    security_opts:
      - "no-new-privileges:true"
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
  become: yes
  register: juice_container

