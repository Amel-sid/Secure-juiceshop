---
# ansible/roles/juice/tasks/main.yml

- name: ğŸ’¥ Supprimer ancienne installation (si elle existe)
  file:
    path: /opt/juice-shop
    state: absent
  become: yes

- name: ğŸ—ï¸ CrÃ©er structure rÃ©pertoires Juice Shop
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: 1001
    group: 1001
  loop:
    - /opt/juice-shop
    - /opt/juice-shop/csaf
  become: yes

# PrÃ©pare les dossiers  pour exposer les bulletins de sÃ©curitÃ© CSAF (.well-known/csaf)
# Simule un Ã©diteur logiciel conforme (divulgation responsable de vulnÃ©rabilitÃ©s)
- name: ğŸ“„ CrÃ©er provider-metadata.json (A.16.1.1	-ResponsabilitÃ©s en matiÃ¨re de gestion des incidents de sÃ©curitÃ©)
  copy:
    content: '{
      "metadata": {
        "publisher": "Juice Shop Security",
        "namespace": "https://juice-sh.op"
      }
    }'
    dest: /opt/juice-shop/csaf/provider-metadata.json
    owner: 1001
    group: 1001
    mode: '0644'
  become: yes


- name: â›“ TÃ©lÃ©charger image Juice Shop (version stable)
  docker_image:
    name: bkimminich/juice-shop
    tag: v15.1.0
    source: pull
  become: yes

- name: ğŸŒ CrÃ©er rÃ©seau Docker privÃ©
  docker_network:
    name: juice_net
    driver: bridge
    state: present
  become: yes

- name: ğŸš€ Lancer conteneur Juice Shop
  docker_container:
    name: juice-shop
    image: bkimminich/juice-shop:v15.1.0 #On tÃ©lÃ©charge et lance lâ€™application Juice Shop dans sa version 15.1.0, depuis Docker Hub.
    state: started
    restart_policy: always
    published_ports:
      - "3000:3000" #Expose le port 3000 de lâ€™app vers le port 3000 de la VM
    user: "1001"
    networks:
      - name: juice_net
    volumes:
      - "/opt/juice-shop/csaf:/juice-shop/.well-known/csaf:ro"
    env:
      NODE_ENV: production
      CSAF_PUBLISHER_NAME: "Juice Shop"
  become: yes
  tags: juice
