---
# 🔐 Créer répertoire SSL
- name: 🔐 Créer répertoire SSL
  file:
    path: "{{ nginx_ssl_path }}"
    state: directory
    mode: '0755'
  become: yes

# 🔐 Générer certificats auto-signés
- name: 🔐 Générer certificats SSL auto-signés
  shell: |
    openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout {{ nginx_ssl_path }}/selfsigned.key \
    -out {{ nginx_ssl_path }}/selfsigned.crt \
    -subj "/C=FR/ST=State/L=City/O=JuiceShop/CN=localhost"
  args:
    creates: "{{ nginx_ssl_path }}/selfsigned.crt"
  become: yes

# 🔒 Sécuriser les permissions
- name: 🔒 Sécuriser permissions certificats
  file:
    path: "{{ item }}"
    mode: '0600'
    owner: root
    group: root
  loop:
    - "{{ nginx_ssl_path }}/selfsigned.key"
    - "{{ nginx_ssl_path }}/selfsigned.crt"
  become: yes