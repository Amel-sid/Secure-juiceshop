---
# 🛑 Nettoyer conteneur nginx existant
- name: 🛑 Supprimer conteneur nginx existant
  docker_container:
    name: juice-proxy
    state: absent
    force_kill: yes
  become: yes
  ignore_errors: yes

# # ✅ Vérifier que Juice Shop est accessible
# - name: ✅ Vérifier disponibilité de Juice Shop
#   uri:
#     url: "http://localhost:{{ juice_shop_external_port }}"
#     method: GET
#     status_code: 200
#   register: juice_check
#   ignore_errors: yes

# 🌐 Lancer conteneur nginx reverse proxy
- name: 🌐 Lancer nginx reverse proxy
  docker_container:
    name: juice-proxy
    image: nginx:alpine
    state: started
    restart_policy: unless-stopped
    published_ports:
      - "80:80"
      - "443:443"
    networks:
      - name: "{{ juice_shop_network }}"
    volumes:
      - "/tmp/nginx-juice.conf:/etc/nginx/conf.d/default.conf:ro"
      - "{{ nginx_ssl_path }}:/etc/nginx/ssl:ro"
    # Limitations de ressources
    memory: 128m
    # Sécurité
    security_opts:
      - "no-new-privileges:true"
  become: yes
  # when: juice_check.status_code == 200

# ⏳ Attendre que nginx soit prêt
- name: ⏳ Attendre que nginx soit prêt
  wait_for:
    port: 443
    host: localhost
    timeout: 30
  # when: juice_check.status_code == 200

# # 🧪 Test de santé final
# - name: 🧪 Test accès HTTPS
#   uri:
#     url: "https://localhost"
#     method: GET
#     status_code: 200
#     validate_certs: no
#   register: https_check
#   retries: 3
#   delay: 5
#   ignore_errors: yes
#   when: juice_check.status_code == 200

# # 📋 Rapport final
# - name: 📋 Rapport de déploiement
#   debug:
#     msg: |
#       🎯 ÉTAT DU DÉPLOIEMENT :
      
#       {% if juice_check.status_code == 200 %}
#       ✅ Juice Shop : http://localhost:{{ juice_shop_external_port }}
      
#       {% if https_check.status_code == 200 %}
#       ✅ Nginx HTTPS : https://localhost
#       ✅ HTTP → HTTPS : http://localhost (redirection automatique)
      
#       🎉 DÉPLOIEMENT RÉUSSI !
#       {% else %}
#       ⚠️  Nginx : problème HTTPS (vérifier certificats)
#       🌐 Accès direct : http://localhost:{{ juice_shop_external_port }}
#       {% endif %}
      
#       {% else %}
#       ❌ Juice Shop non accessible
#       🔧 Vérifier : docker logs juice-shop
#       {% endif %}
      
#       🔧 Commandes utiles :
#       - docker ps
#       - docker logs juice-shop
#       - docker logs juice-proxy