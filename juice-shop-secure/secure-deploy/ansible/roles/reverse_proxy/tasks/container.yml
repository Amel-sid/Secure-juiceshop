---
# ğŸ›‘ Nettoyer conteneur nginx existant
- name: ğŸ›‘ Supprimer conteneur nginx existant
  docker_container:
    name: juice-proxy
    state: absent
    force_kill: yes
  become: yes
  ignore_errors: yes

# # âœ… VÃ©rifier que Juice Shop est accessible
# - name: âœ… VÃ©rifier disponibilitÃ© de Juice Shop
#   uri:
#     url: "http://localhost:{{ juice_shop_external_port }}"
#     method: GET
#     status_code: 200
#   register: juice_check
#   ignore_errors: yes

# ğŸŒ Lancer conteneur nginx reverse proxy
- name: ğŸŒ Lancer nginx reverse proxy
  docker_container:
    name: juice-proxy
    image: nginx:alpine
    state: started
    restart_policy: unless-stopped
    published_ports:
      - "80:80"
      - "443:443"
    networks:
      - name: "{{ juice_shop_network }}"
    volumes:
      - "/tmp/nginx-juice.conf:/etc/nginx/conf.d/default.conf:ro"
      - "{{ nginx_ssl_path }}:/etc/nginx/ssl:ro"
    # Limitations de ressources
    memory: 128m
    # SÃ©curitÃ©
    security_opts:
      - "no-new-privileges:true"
  become: yes
  # when: juice_check.status_code == 200

# â³ Attendre que nginx soit prÃªt
- name: â³ Attendre que nginx soit prÃªt
  wait_for:
    port: 443
    host: localhost
    timeout: 30
  # when: juice_check.status_code == 200

# # ğŸ§ª Test de santÃ© final
# - name: ğŸ§ª Test accÃ¨s HTTPS
#   uri:
#     url: "https://localhost"
#     method: GET
#     status_code: 200
#     validate_certs: no
#   register: https_check
#   retries: 3
#   delay: 5
#   ignore_errors: yes
#   when: juice_check.status_code == 200

# # ğŸ“‹ Rapport final
# - name: ğŸ“‹ Rapport de dÃ©ploiement
#   debug:
#     msg: |
#       ğŸ¯ Ã‰TAT DU DÃ‰PLOIEMENT :
      
#       {% if juice_check.status_code == 200 %}
#       âœ… Juice Shop : http://localhost:{{ juice_shop_external_port }}
      
#       {% if https_check.status_code == 200 %}
#       âœ… Nginx HTTPS : https://localhost
#       âœ… HTTP â†’ HTTPS : http://localhost (redirection automatique)
      
#       ğŸ‰ DÃ‰PLOIEMENT RÃ‰USSI !
#       {% else %}
#       âš ï¸  Nginx : problÃ¨me HTTPS (vÃ©rifier certificats)
#       ğŸŒ AccÃ¨s direct : http://localhost:{{ juice_shop_external_port }}
#       {% endif %}
      
#       {% else %}
#       âŒ Juice Shop non accessible
#       ğŸ”§ VÃ©rifier : docker logs juice-shop
#       {% endif %}
      
#       ğŸ”§ Commandes utiles :
#       - docker ps
#       - docker logs juice-shop
#       - docker logs juice-proxy