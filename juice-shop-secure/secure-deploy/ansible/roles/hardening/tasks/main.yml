---
# ===================== SECTION 1: CONFIGURATION RÃ‰SEAU =====================
- name: ğŸ”’ CONFIGURATION PAREFEUX (ISO 27001 A.13.1.1)
  block:
    - name: âœ¨ Activer UFW avec politique restrictive
      ufw:
        state: enabled
        policy: deny
        logging: medium

    # COMMENTÃ‰ - Cause problÃ¨me SSH Vagrant
    # - name: ğŸ”’ Autoriser SSH depuis IP admin
    #   ufw:
    #     rule: allow
    #     port: "{{ ssh_port }}"
    #     proto: tcp
    #     src: "{{ admin_ip }}/32"

    # AJOUTÃ‰ - Autoriser SSH pour Vagrant
    - name: ğŸ”’ Autoriser SSH Vagrant
      ufw:
        rule: allow
        port: 22
        proto: tcp

    - name: ğŸš« Bloquer accÃ¨s direct Ã  Juice Shop
      ufw:
        rule: deny
        port: 3000
        proto: tcp

    - name: ğŸŒ Autoriser HTTPS
      ufw:
        rule: allow
        port: 443
        proto: tcp

    - name: ğŸŒ Autoriser HTTP
      ufw:
        rule: allow
        port: 80
        proto: tcp
  tags: ["firewall"]

# ===================== SECTION 2: DURCISSEMENT SSH =====================
- name: ğŸ” DURCISSEMENT SSH (ISO 27001 A.9.4.2)
  block:
    # COMMENTÃ‰ - Cause problÃ¨me port SSH
    # - name: ğŸ”§ Changer port SSH
    #   lineinfile:
    #     path: /etc/ssh/sshd_config
    #     regexp: '^#?Port'
    #     line: 'Port {{ ssh_port }}'
    #     backup: yes
    #     validate: '/usr/sbin/sshd -t -f %s'

    # COMMENTÃ‰ - Cause problÃ¨me authentification Vagrant
    # - name: ğŸ”‘ Forcer authentification par clÃ©
    #   lineinfile:
    #     path: /etc/ssh/sshd_config
    #     regexp: '^#?AuthenticationMethods'
    #     line: 'AuthenticationMethods publickey'
    #     validate: '/usr/sbin/sshd -t -f %s'

    - name: â± Limiter tentatives de connexion
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?MaxAuthTries'
        line: 'MaxAuthTries 3'
        validate: '/usr/sbin/sshd -t -f %s'

    - name: â›” DÃ©sactiver options dangereuses
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?{{ item.key }}'
        line: '{{ item.value }}'
        validate: '/usr/sbin/sshd -t -f %s'
      loop:
        - { key: 'X11Forwarding', value: 'X11Forwarding no' }
        - { key: 'AllowTcpForwarding', value: 'AllowTcpForwarding no' }
        - { key: 'PermitTunnel', value: 'PermitTunnel no' }
        - { key: 'ClientAliveInterval', value: 'ClientAliveInterval 300' }
        - { key: 'ClientAliveCountMax', value: 'ClientAliveCountMax 2' }

    - name: ğŸ”„ RedÃ©marrer SSH
      systemd:
        name: ssh
        state: restarted
  tags: ["ssh"]

# ===================== SECTION 3: OUTILS DE SÃ‰CURITÃ‰ =====================
- name: ğŸ›¡ï¸ OUTILS DE PROTECTION (ISO 27001 A.12.6)
  block:
    # ----- SOUS-SECTION: Fail2Ban -----
    - name: ğŸ›¡ Installer et configurer Fail2Ban
      block:
        - name: ğŸ“¦ Installer Fail2Ban
          apt:
            name: fail2ban
            state: present

        - name: ğŸ”§ Configurer jail SSH
          copy:
            dest: /etc/fail2ban/jail.d/sshd.conf
            content: |
              [sshd]
              enabled = true
              port = 22
              filter = sshd
              logpath = /var/log/auth.log
              maxretry = 3
              bantime = 1h
              findtime = 10m
              ignoreip = 127.0.0.1/8 10.0.0.0/8 192.168.0.0/16

        - name: ğŸ”§ Configurer jail Nginx
          copy:
            dest: /etc/fail2ban/jail.d/nginx.conf
            content: |
              [nginx-http-auth]
              enabled = true
              port = http,https
              logpath = /var/log/nginx/error.log
              maxretry = 3
          notify: restart fail2ban
      
    # ----- SOUS-SECTION: AppArmor -----
    - name: ğŸ›¡ Installer et activer AppArmor
      block:
        - name: ğŸ“¦ Installer AppArmor
          apt:
            name:
              - apparmor
              - apparmor-utils
              - apparmor-profiles
            state: present
            update_cache: no

        - name: ğŸ”„ Activer AppArmor
          service:
            name: apparmor
            state: started
            enabled: true

        - name: ğŸ”’ Appliquer profil Docker
          copy:
            dest: /etc/apparmor.d/docker
            content: |
              #include <tunables/global>
              profile docker flags=(attach_disconnected) {
                deny /etc/passwd rw,
                deny /etc/shadow rw,
                deny /root/** rw,
                capability dac_override,
              }
          notify: reload apparmor
      
    # ----- SOUS-SECTION: Mises Ã  jour -----
    - name: â™»ï¸ Activer mises Ã  jour automatiques
      apt:
        name: unattended-upgrades
        state: present
  tags: ["security-tools"]